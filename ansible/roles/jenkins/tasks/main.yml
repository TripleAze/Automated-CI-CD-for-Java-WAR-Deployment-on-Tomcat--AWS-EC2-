- name: Install Java 21
  apt:
    name: openjdk-21-jdk
    state: present
    update_cache: yes

- name: Install Maven
  apt:
    name: maven
    state: present

- name: Download Jenkins GPG key
  apt_key:
    url: https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
    state: present

- name: Download Jenkins repo
  apt_repository:
    repo: "deb https://pkg.jenkins.io/debian-stable binary/"
    state: present
    filename: jenkins

- name: Install Jenkins
  apt:
    name: jenkins
    state: present
    update_cache: yes

- name: Ensure Jenkins systemd override directory exists
  file:
    path: /etc/systemd/system/jenkins.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Set Jenkins to use Java 21 via systemd override
  copy:
    dest: /etc/systemd/system/jenkins.service.d/override.conf
    content: |
      [Service]
      Environment="JENKINS_JAVA_CMD=/usr/lib/jvm/java-21-openjdk-amd64/bin/java"
  register: jenkins_java_override

- name: Reload systemd and restart Jenkins
  systemd:
    name: jenkins
    state: restarted
    daemon_reload: yes
  when: jenkins_java_override.changed

- name: Start and enable Jenkins
  systemd:
    name: jenkins
    state: started
    enabled: yes

- name: Wait for Jenkins to start
  wait_for:
    port: 8080
    delay: 10
    timeout: 300

- name: Download Jenkins CLI
  get_url:
    url: http://localhost:8080/jnlpJars/jenkins-cli.jar
    dest: /opt/jenkins-cli.jar
  register: cli_download
  until: cli_download is success
  retries: 5
  delay: 10

- name: Create .ssh directory for jenkins
  file:
    path: /var/lib/jenkins/.ssh
    state: directory
    owner: jenkins
    group: jenkins
    mode: '0700'

- name: Check if initial admin password exists
  stat:
    path: /var/lib/jenkins/secrets/initialAdminPassword
  register: initial_password_file

- name: Read initial admin password
  slurp:
    src: /var/lib/jenkins/secrets/initialAdminPassword
  register: admin_password_raw
  when: initial_password_file.stat.exists

- name: Set admin password fact
  set_fact:
    jenkins_admin_password: "{{ admin_password_raw['content'] | b64decode | trim if initial_password_file.stat.exists else (jenkins_admin_password | default('')) }}"

- name: Install Jenkins plugins via CLI
  shell: "java -jar /opt/jenkins-cli.jar -s http://localhost:8080/ -auth admin:{{ jenkins_admin_password }} install-plugin {{ item }} -deploy"
  loop:
    - github
    - ssh-credentials
    - ssh-agent
    - git
  register: plugin_install
  changed_when: "'Installing' in plugin_install.stdout or 'Success' in plugin_install.stdout"

- name: Restart Jenkins
  systemd:
    name: jenkins
    state: restarted

- name: Wait for Jenkins to recover
  uri:
    url: "http://localhost:8080/login"
    status_code: 200, 403
  register: _result
  until: _result.status == 200 or _result.status == 403
  retries: 60
  delay: 5

- name: Create credentials script from template
  template:
    src: add-credentials.groovy.j2
    dest: /tmp/add-credentials.groovy

- name: Execute Groovy script to add Tomcat SSH credentials
  shell: "java -jar /opt/jenkins-cli.jar -s http://localhost:8080/ -auth admin:{{ jenkins_admin_password }} groovy = < /tmp/add-credentials.groovy"
  register: groovy_exec
  failed_when: "'Error' in groovy_exec.stderr"
  ignore_errors: yes

- name: Verify Jenkins is running with Java 21
  shell: "ps aux | grep jenkins"
  register: jenkins_process
  changed_when: false

- name: Print Jenkins process info
  debug:
    var: jenkins_process.stdout_lines

- name: Install Nginx and Certbot dependencies
  apt:
    name:
      - nginx
      - certbot
      - python3-certbot-nginx
    state: present

- name: Create Nginx configuration for Jenkins proxy
  template:
    src: subdomain.conf.j2
    dest: /etc/nginx/sites-available/jenkins
  vars:
    domain_name: "{{ jenkins_domain }}"

- name: Enable Jenkins site configuration
  file:
    src: /etc/nginx/sites-available/jenkins
    dest: /etc/nginx/sites-enabled/jenkins
    state: link

- name: Remove default Nginx config
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Test Nginx config and restart
  service:
    name: nginx
    state: restarted

- name: Obtain Let's Encrypt certificate
  shell: >
    certbot --nginx 
    -d {{ jenkins_domain }} 
    --non-interactive 
    --agree-tos 
    -m {{ ssl_email }} 
    --redirect
  args:
    creates: "/etc/letsencrypt/live/{{ jenkins_domain }}/fullchain.pem"

- name: Ensure Certbot renewal timer is running
  systemd:
    name: certbot.timer
    enabled: yes
    state: started

    
